#include "crow.h"
#include <sqlite3.h>
#include <sstream>
#include <iostream>

int main() {
    crow::SimpleApp app;
    sqlite3* db;
    char* errMsg = nullptr;

    if (sqlite3_open("hospital.db", &db)) {
        std::cerr << "Error opening database\n";
        return 1;
    }

    // Create tables
    const char* patients_sql =
        "CREATE TABLE IF NOT EXISTS patients ("
        "id INTEGER PRIMARY KEY AUTOINCREMENT, "
        "name TEXT NOT NULL, "
        "disease TEXT NOT NULL, "
        "created_at TEXT DEFAULT CURRENT_TIMESTAMP);";
    sqlite3_exec(db, patients_sql, nullptr, nullptr, &errMsg);

    const char* doctors_sql =
        "CREATE TABLE IF NOT EXISTS doctors ("
        "id INTEGER PRIMARY KEY AUTOINCREMENT, "
        "name TEXT NOT NULL, "
        "specialization TEXT NOT NULL);";
    sqlite3_exec(db, doctors_sql, nullptr, nullptr, &errMsg);

    // Login page
    CROW_ROUTE(app, "/")([]() {
        std::ostringstream html;
        html << R"(
        <!DOCTYPE html>
        <html lang='en'>
        <head>
            <meta charset='UTF-8'>
            <meta name='viewport' content='width=device-width, initial-scale=1.0'>
            <title>Hospital Login</title>
            <link rel='stylesheet' href='https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css'>
            <style>
                body { font-family: Arial,sans-serif; margin:0; display:flex; justify-content:center; align-items:center; height:100vh; background:#f4f7f9; }
                .login-container { background:white; padding:30px; border-radius:12px; box-shadow:0 2px 15px rgba(0,0,0,0.1); width:300px; text-align:center; }
                input { width:100%; padding:10px; margin:10px 0; border-radius:6px; border:1px solid #ccc; }
                button { background:#3498db; color:white; border:none; padding:10px 20px; border-radius:6px; cursor:pointer; width:100%; }
                button:hover { background:#2980b9; }
            </style>
        </head>
        <body>
            <div class='login-container'>
                <h2><i class='fa fa-hospital'></i> Hospital Login</h2>
                <input type='text' id='username' placeholder='Username'>
                <input type='password' id='password' placeholder='Password'>
                <button onclick='login()'>Login</button>
            </div>
            <script>
                function login(){
                    const user=document.getElementById('username').value;
                    const pass=document.getElementById('password').value;
                    if(user==='admin' && pass==='admin'){ window.location='/dashboard'; }
                    else{ alert('Invalid credentials'); }
                }
            </script>
        </body>
        </html>
        )";
        return html.str();
    });

    // Dashboard with full CRUD
    CROW_ROUTE(app, "/dashboard")([]() {
        std::ostringstream html;
        html << R"(
        <!DOCTYPE html>
        <html lang='en'>
        <head>
            <meta charset='UTF-8'>
            <meta name='viewport' content='width=device-width, initial-scale=1.0'>
            <title>Hospital Dashboard</title>
            <link rel='stylesheet' href='https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css'>
            <script src='https://cdn.jsdelivr.net/npm/chart.js'></script>
            <style>
                body { font-family: Arial,sans-serif; margin:0; background:#f4f7f9; }
                .header { background:#3498db; color:white; padding:15px; display:flex; justify-content:space-between; align-items:center; }
                .header h1 { margin:0; font-size:1.5em; }
                .container { padding:20px; display:flex; flex-wrap:wrap; gap:20px; justify-content:center; }
                .card { background:white; border-radius:12px; padding:15px; box-shadow:0 2px 10px rgba(0,0,0,0.1); flex:1 1 250px; min-width:250px; }
                table { width:100%; border-collapse:collapse; margin-top:10px; }
                th,td { padding:8px; border-bottom:1px solid #ddd; text-align:left; }
                th { background:#3498db; color:white; }
                input, select { width:100%; padding:8px; margin:5px 0; border-radius:6px; border:1px solid #ccc; }
                button { background:#3498db; color:white; border:none; padding:6px 12px; border-radius:6px; cursor:pointer; margin-top:5px; }
                button:hover { background:#2980b9; }
                .action-btn { padding:5px 10px; margin:2px; font-size:0.85em; border-radius:6px; cursor:pointer; color:white; border:none; }
                .edit-btn { background:#28a745; }
                .edit-btn:hover { background:#1e7e34; }
                .delete-btn { background:#dc3545; }
                .delete-btn:hover { background:#b02a37; }
                #darkToggle { float:right; margin-left:10px; cursor:pointer; }
                @media(max-width:768px) { .container { flex-direction:column; } }
            </style>
        </head>
        <body>
            <div class='header'>
                <h1><i class='fa fa-hospital'></i> Hospital Dashboard</h1>
                <div>
                    <i class='fa fa-moon' id='darkToggle' onclick='toggleDark()'></i>
                    <i class='fa fa-user-circle'></i> Admin
                </div>
            </div>

            <div style='padding:20px; text-align:center;'>
                <input id='searchPatient' placeholder='Search patient by name...' oninput='loadPatients()' style='width:50%; padding:8px; margin-bottom:15px;'>
            </div>

            <div class='container'>
                <!-- Patients Card -->
                <div class='card'>
                    <h3>Patients</h3>
                    <input id='p_name' placeholder='Patient Name'>
                    <input id='p_disease' placeholder='Disease'>
                    <button onclick='addPatient()'><i class='fa fa-plus'></i> Add Patient</button>
                    <table>
                        <thead><tr><th>ID</th><th>Name</th><th>Disease</th><th>Date</th><th>Actions</th></tr></thead>
                        <tbody id='patientsBody'></tbody>
                    </table>
                </div>

                <!-- Doctors Card -->
                <div class='card'>
                    <h3>Doctors</h3>
                    <input id='d_name' placeholder='Doctor Name'>
                    <input id='d_spec' placeholder='Specialization'>
                    <button onclick='addDoctor()'><i class='fa fa-plus'></i> Add Doctor</button>
                    <table>
                        <thead><tr><th>ID</th><th>Name</th><th>Specialization</th><th>Actions</th></tr></thead>
                        <tbody id='doctorsBody'></tbody>
                    </table>
                </div>

                <!-- Graph Card -->
                <div class='card' style='flex:1 1 500px;'>
                    <h3>Patients per Day</h3>
                    <canvas id='patientsChart'></canvas>
                </div>
            </div>

            <script>
                // DARK MODE
                function toggleDark(){
                    if(document.body.style.background==='rgb(44, 62, 80)'){
                        document.body.style.background='#f4f7f9';
                        document.body.style.color='';
                    } else{
                        document.body.style.background='#2c3e50';
                        document.body.style.color='white';
                    }
                }

                // PATIENT CRUD
                async function loadPatients(){
                    const q=document.getElementById('searchPatient').value.toLowerCase();
                    const res=await fetch('/patients');
                    const data=await res.json();
                    const tbody=document.getElementById('patientsBody');
                    tbody.innerHTML='';
                    data.forEach(p=>{
                        if(q && !p.name.toLowerCase().includes(q)) return;
                        tbody.innerHTML+=`<tr>
                            <td>${p.id}</td>
                            <td>${p.name}</td>
                            <td>${p.disease}</td>
                            <td>${p.created_at}</td>
                            <td>
                                <button class='action-btn edit-btn' onclick='editPatient(${p.id})'><i class='fa fa-edit'></i></button>
                                <button class='action-btn delete-btn' onclick='deletePatient(${p.id})'><i class='fa fa-trash'></i></button>
                            </td>
                        </tr>`;
                    });
                    updateChart(data);
                }

                async function addPatient(){
                    const name=document.getElementById('p_name').value.trim();
                    const disease=document.getElementById('p_disease').value.trim();
                    if(!name||!disease){ alert('Fill all fields'); return; }
                    await fetch('/add_patient',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({name,disease})});
                    document.getElementById('p_name').value='';
                    document.getElementById('p_disease').value='';
                    loadPatients();
                }

                async function editPatient(id){
                    const name=prompt('New patient name:');
                    const disease=prompt('New disease:');
                    if(!name||!disease) return;
                    await fetch('/edit_patient',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({id,name,disease})});
                    loadPatients();
                }

                async function deletePatient(id){
                    if(!confirm('Delete this patient?')) return;
                    await fetch('/delete_patient',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({id})});
                    loadPatients();
                }

                // DOCTOR CRUD
                async function loadDoctors(){
                    const res=await fetch('/doctors');
                    const data=await res.json();
                    const tbody=document.getElementById('doctorsBody');
                    tbody.innerHTML='';
                    data.forEach(d=>{
                        tbody.innerHTML+=`<tr>
                            <td>${d.id}</td>
                            <td>${d.name}</td>
                            <td>${d.specialization}</td>
                            <td>
                                <button class='action-btn edit-btn' onclick='editDoctor(${d.id})'><i class='fa fa-edit'></i></button>
                                <button class='action-btn delete-btn' onclick='deleteDoctor(${d.id})'><i class='fa fa-trash'></i></button>
                            </td>
                        </tr>`;
                    });
                }

                async function addDoctor(){
                    const name=document.getElementById('d_name').value.trim();
                    const spec=document.getElementById('d_spec').value.trim();
                    if(!name||!spec){ alert('Fill all fields'); return; }
                    await fetch('/add_doctor',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({name,specialization:spec})});
                    document.getElementById('d_name').value='';
                    document.getElementById('d_spec').value='';
                    loadDoctors();
                }

                async function editDoctor(id){
                    const name=prompt('New doctor name:');
                    const spec=prompt('New specialization:');
                    if(!name||!spec) return;
                    await fetch('/edit_doctor',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({id,name,specialization:spec})});
                    loadDoctors();
                }

                async function deleteDoctor(id){
                    if(!confirm('Delete this doctor?')) return;
                    await fetch('/delete_doctor',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({id})});
                    loadDoctors();
                }

                // Chart
                let chart=null;
                function updateChart(data){
                    const counts={};
                    data.forEach(p=>{
                        const day=p.created_at.split(' ')[0];
                        counts[day]=(counts[day]||0)+1;
                    });
                    const labels=Object.keys(counts);
                    const values=Object.values(counts);
                    const ctx=document.getElementById('patientsChart').getContext('2d');
                    if(chart) chart.destroy();
                    chart=new Chart(ctx,{type:'bar',data:{labels,datasets:[{label:'Patients per Day',data:values,backgroundColor:'#3498db'}]},options:{responsive:true}});
                }

                window.onload=function(){ loadPatients(); loadDoctors(); };
            </script>
        </body>
        </html>
        )";
        return html.str();
    });

    // CRUD Routes

    // Add patient
    CROW_ROUTE(app, "/add_patient").methods("POST"_method)([db](const crow::request &req){
        auto b=crow::json::load(req.body);
        if(!b || !b.has("name") || !b.has("disease")) return crow::response(400,"Invalid");
        std::string name=b["name"].s();
        std::string disease=b["disease"].s();
        sqlite3_stmt* stmt;
        sqlite3_prepare_v2(db,"INSERT INTO patients(name,disease) VALUES(?,?)",-1,&stmt,nullptr);
        sqlite3_bind_text(stmt,1,name.c_str(),-1,SQLITE_STATIC);
        sqlite3_bind_text(stmt,2,disease.c_str(),-1,SQLITE_STATIC);
        sqlite3_step(stmt); sqlite3_finalize(stmt);
        return crow::response(200,"OK");
    });

    // Edit patient
    CROW_ROUTE(app,"/edit_patient").methods("POST"_method)([db](const crow::request &req){
        auto b=crow::json::load(req.body);
        if(!b||!b.has("id")||!b.has("name")||!b.has("disease")) return crow::response(400,"Invalid");
        int id=b["id"].i();
        std::string name=b["name"].s();
        std::string disease=b["disease"].s();
        sqlite3_stmt* stmt;
        sqlite3_prepare_v2(db,"UPDATE patients SET name=?,disease=? WHERE id=?",-1,&stmt,nullptr);
        sqlite3_bind_text(stmt,1,name.c_str(),-1,SQLITE_STATIC);
        sqlite3_bind_text(stmt,2,disease.c_str(),-1,SQLITE_STATIC);
        sqlite3_bind_int(stmt,3,id);
        sqlite3_step(stmt); sqlite3_finalize(stmt);
        return crow::response(200,"OK");
    });

    // Delete patient
    CROW_ROUTE(app,"/delete_patient").methods("POST"_method)([db](const crow::request &req){
        auto b=crow::json::load(req.body);
        if(!b||!b.has("id")) return crow::response(400,"Invalid");
        int id=b["id"].i();
        sqlite3_stmt* stmt;
        sqlite3_prepare_v2(db,"DELETE FROM patients WHERE id=?",-1,&stmt,nullptr);
        sqlite3_bind_int(stmt,1,id);
        sqlite3_step(stmt); sqlite3_finalize(stmt);
        return crow::response(200,"OK");
    });

    // Get patients
    CROW_ROUTE(app,"/patients")([db](){
        crow::json::wvalue arr; arr=crow::json::wvalue::list();
        sqlite3_stmt* stmt;
        sqlite3_prepare_v2(db,"SELECT id,name,disease,created_at FROM patients",-1,&stmt,nullptr);
        int idx=0;
        while(sqlite3_step(stmt)==SQLITE_ROW){
            crow::json::wvalue obj;
            obj["id"]=sqlite3_column_int(stmt,0);
            obj["name"]=std::string(reinterpret_cast<const char*>(sqlite3_column_text(stmt,1)));
            obj["disease"]=std::string(reinterpret_cast<const char*>(sqlite3_column_text(stmt,2)));
            obj["created_at"]=std::string(reinterpret_cast<const char*>(sqlite3_column_text(stmt,3)));
            arr[idx++]=std::move(obj);
        }
        sqlite3_finalize(stmt);
        return crow::response(arr);
    });

    // Add doctor
    CROW_ROUTE(app,"/add_doctor").methods("POST"_method)([db](const crow::request &req){
        auto b=crow::json::load(req.body);
        if(!b||!b.has("name")||!b.has("specialization")) return crow::response(400,"Invalid");
        std::string name=b["name"].s();
        std::string spec=b["specialization"].s();
        sqlite3_stmt* stmt;
        sqlite3_prepare_v2(db,"INSERT INTO doctors(name,specialization) VALUES(?,?)",-1,&stmt,nullptr);
        sqlite3_bind_text(stmt,1,name.c_str(),-1,SQLITE_STATIC);
        sqlite3_bind_text(stmt,2,spec.c_str(),-1,SQLITE_STATIC);
        sqlite3_step(stmt); sqlite3_finalize(stmt);
        return crow::response(200,"OK");
    });

    // Edit doctor
    CROW_ROUTE(app,"/edit_doctor").methods("POST"_method)([db](const crow::request &req){
        auto b=crow::json::load(req.body);
        if(!b||!b.has("id")||!b.has("name")||!b.has("specialization")) return crow::response(400,"Invalid");
        int id=b["id"].i();
        std::string name=b["name"].s();
        std::string spec=b["specialization"].s();
        sqlite3_stmt* stmt;
        sqlite3_prepare_v2(db,"UPDATE doctors SET name=?,specialization=? WHERE id=?",-1,&stmt,nullptr);
        sqlite3_bind_text(stmt,1,name.c_str(),-1,SQLITE_STATIC);
        sqlite3_bind_text(stmt,2,spec.c_str(),-1,SQLITE_STATIC);
        sqlite3_bind_int(stmt,3,id);
        sqlite3_step(stmt); sqlite3_finalize(stmt);
        return crow::response(200,"OK");
    });

    // Delete doctor
    CROW_ROUTE(app,"/delete_doctor").methods("POST"_method)([db](const crow::request &req){
        auto b=crow::json::load(req.body);
        if(!b||!b.has("id")) return crow::response(400,"Invalid");
        int id=b["id"].i();
        sqlite3_stmt* stmt;
        sqlite3_prepare_v2(db,"DELETE FROM doctors WHERE id=?",-1,&stmt,nullptr);
        sqlite3_bind_int(stmt,1,id);
        sqlite3_step(stmt); sqlite3_finalize(stmt);
        return crow::response(200,"OK");
    });

    // Get doctors
    CROW_ROUTE(app,"/doctors")([db](){
        crow::json::wvalue arr; arr=crow::json::wvalue::list();
        sqlite3_stmt* stmt;
        sqlite3_prepare_v2(db,"SELECT id,name,specialization FROM doctors",-1,&stmt,nullptr);
        int idx=0;
        while(sqlite3_step(stmt)==SQLITE_ROW){
            crow::json::wvalue obj;
            obj["id"]=sqlite3_column_int(stmt,0);
            obj["name"]=std::string(reinterpret_cast<const char*>(sqlite3_column_text(stmt,1)));
            obj["specialization"]=std::string(reinterpret_cast<const char*>(sqlite3_column_text(stmt,2)));
            arr[idx++]=std::move(obj);
        }
        sqlite3_finalize(stmt);
        return crow::response(arr);
    });

    app.port(8080).multithreaded().run();
    sqlite3_close(db);
}
